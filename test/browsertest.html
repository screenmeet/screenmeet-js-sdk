<!DOCTYPE html>
<html>
<head>
    <title>Hello</title>
    <script src="../build/bundle.js"></script>

</head>
<body>
Hello <div id="userinfo"></div>
<br/><br/>

<button onClick="doLogin()">Log in</button>
<button onClick="doLogout()">Log out</button>
<br/><br/>
<button onClick="createSession('support')">Create Support Session</button>
<button onClick="createSession('live')">Create Live Session</button>
<button onClick="createSession('cobrowse')">Create Cobrowse Session</button>
<button onClick="createSession('replay')">Create Replay Session</button>
<br><br/>
<button onClick="createRelatedSession('support')">Create Support Session (related)</button>

<br/><br/>
<b>User Sessions:</b>
<div id="sessions"></div>
<br/><br/>
<b>Object related sessions:</b><br/>
<div id="objsessions"></div>

<script>
  let opts = {"persistSession" : true,
    eventHandlers:{
      authenticated: updateUserInfo,
      signout: updateUserInfo
    }};

  let SM = window.SM = new ScreenMeet(opts);
  SM.api.setBaseUrl('https://ea-home-dev.screenmeet.com:3002/v3');
  SM.init();
  const objectKey = 'spiffycrm.acmebrand.case.g4j231j8f';

  /**
   * Sample function demonstrating login
   */
  async function  doLogin() {

    let cburl = 'https://ea-home-dev.screenmeet.com:3056/test/oauth_cb.html';
    let provider = 'zendesk';
    let instance = 'https://screenmeetdev.zendesk.com'

    try {
      let result = await SM.login(provider, cburl, instance);
      console.log(result);
    } catch (er) {
      console.log('login failed');
      console.error(er);
    }
  }

  /**
   * Sample function demonstrating logout
   **/
  async function doLogout() {
    if (!SM.isAuthenticated) {
      console.log('signout: User is not signed in, nothing to do');
      return;
    }

    SM.signout();

  }

/**
 * Creates a session with no external entity association - just owned by the user
 */
  async function createSession(type) {
    try {
      let result = await SM.createAdhocSession(type, `My ${type} session`);
      console.log('created session', result);
      refreshSessions();
    } catch (er) {
      console.error(er);
      console.log('Failed to create session');
    }
  }

  /**
   * Creates a session associated with an external object.
   */
  async function createRelatedSession(type) {
    try {
      let result = await SM.createRelatedSession(type, `My ${type} session`, {},
        {
          'app ' : 'demoapp',
          'type' : 'case', //object type
          'name' : 'My demo case', //name of object - goes into label field
          'sync' : false
        },
        objectKey
      );
      console.log('created session', result);
      refreshSessions();
    } catch (er) {
      console.error(er);
      console.log('Failed to create session');
    }
  }

  /**
   * Basic function that updates user name list
   */
  function updateUserInfo(userInfo) {
    let infoElement = document.getElementById('userinfo');
    if (userInfo && userInfo.user) {
      infoElement.innerHTML = JSON.stringify(userInfo.user);
      refreshSessions();
    } else {
      infoElement.innerText = 'Unauthenticated user';
      document.getElementById('sessions').innerHTML = '';
      document.getElementById('objsessions').innerHTML = '';
    }
  }

  async function refreshSessions() {
    if (!SM.isAuthenticated) return;


    //refresh all object related sessions
    let objSessionHtml = '';
    let relatedSessions = await SM.listRelatedObjectSessions(objectKey, false);

    relatedSessions.forEach((s) => {
      objSessionHtml += renderSession(s);
    });

    //rerfresh all user sessions
    let sessions = await SM.listUserSessions(null, false);

    let sessionsHtml = '';
    sessions.rows.forEach((s) => {
      sessionsHtml += renderSession(s);
    });

    document.getElementById('sessions').innerHTML = sessionsHtml;
    document.getElementById('objsessions').innerHTML = objSessionHtml;

  }

  async function closeSession(id) {
    await SM.closeSession(id);
    this.refreshSessions();
  }

  function renderSession (session) {
    let urls = SM.getUrls(session);

    let urlsHTML = '';

    if (urls.invite) {
      urlsHTML += ` <a href='${urls.invite}'>invite link</a> `;
    }
    if (urls.host) {
      urlsHTML += ` <a href='${urls.host}'>host link</a> `;
    }
    let sessionHtmlRow = `<div>[${session.id}][${session.status}][${session.type}] ${session.label} [${urlsHTML}] [<a href="javascript:void(0)" onClick="closeSession('${session.id}')">X</a>]</div>`;
    return sessionHtmlRow;
  }

</script>

</body>
</html>